<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--Converted with LaTeX2HTML 2018.3 (Released July 19, 2018) -->
<HTML lang="EN">
<HEAD>
<TITLE>conjugate_gradients() &mdash; optimize atoms given restraints, with CG</TITLE>
<META NAME="description" CONTENT="conjugate_gradients() &mdash; optimize atoms given restraints, with CG">
<META NAME="keywords" CONTENT="manual">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="viewport" CONTENT="width=device-width, initial-scale=1.0">
<META NAME="Generator" CONTENT="LaTeX2HTML v2018.3">

<LINK REL="STYLESHEET" HREF="manual.css">
<LINK REL="STYLESHEET" HREF="pygments.css">

<LINK REL="next" HREF="node268.html">
<LINK REL="previous" HREF="node266.html">
<LINK REL="next" HREF="node268.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><!--Navigation Panel-->
<A
 HREF="node268.html">
<IMG WIDTH="37" HEIGHT="24" ALT="next" SRC="next.png"></A> 
<A
 HREF="node266.html">
<IMG WIDTH="26" HEIGHT="24" ALT="up" SRC="up.png"></A> 
<A
 HREF="node266.html">
<IMG WIDTH="63" HEIGHT="24" ALT="previous" SRC="prev.png"></A> 
<A ID="tex2html3173"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALT="contents" SRC="contents.png"></A> 
<A ID="tex2html3175"
  HREF="node513.html">
<IMG WIDTH="43" HEIGHT="24" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A
 HREF="node268.html">quasi_newton()   optimize</A>
<B> Up:</B> <A
 HREF="node266.html">The optimizers module: optimization</A>
<B> Previous:</B> <A
 HREF="node266.html">The optimizers module: optimization</A>
 &nbsp; <B>  <A ID="tex2html3174"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A ID="tex2html3176"
  HREF="node513.html">Index</A></B> 
<BR>
<BR></DIV>
<!--End of Navigation Panel-->

<H2><A ID="SECTION0011111000000000000000">
conjugate_gradients() &mdash; optimize atoms given restraints, with CG</A>
</H2> <A NAME="25144"></A><A ID="CMD:conjugategradients"></A>
<A NAME="25147"></A><TT>conjugate_gradients(output='NO_REPORT', min_atom_shift=0.01, residue_span_range=(0, 99999), **vars)</TT>
<BR>
<A NAME="24947"></A>
<DL>
<DT><STRONG>Output:</STRONG></DT>
<DD><I CLASS="sans">molpdf</I><A NAME="25154"></A>
                             
</DD>
</DL>

<P>
<DL>
<DT><STRONG>Requirements:</STRONG></DT>
<DD>restraints
                             
</DD>
</DL>

<P>
<BLOCKQUOTE>
This command creates a new <A ID="tex2html150"
  HREF="https://www.python.org/">Python</A> optimizer object. Calling the
object's <TT>optimize</TT> method with an atom selection then performs a number of
optimizing iterations using a modified version of the Beale restart conjugate
gradients method [<A
 HREF="node512.html#ShaPhu80">Shanno &amp; Phua, 1980</A>,<A
 HREF="node512.html#ACM500">Shanno &amp; Phua, 1982</A>].
A brief description of the algorithm is given in
Section&nbsp;<A HREF="node488.html#SECTION:energydesc">A.2</A>.
</BLOCKQUOTE>
<P>
<BLOCKQUOTE>The optimization can be controlled with a number of keyword arguments, which
can be specified either when the object is created, or when the <TT>optimize</TT>
method is called (if the same keyword is specified in both, that for the
<TT>optimize</TT> method takes precedence). Valid keywords are:
</BLOCKQUOTE>
<P>

<UL>
<LI><I CLASS="sans">min_atom_shift</I><A NAME="25200"></A> is a convergence criterion for the optimization.
When the maximal atomic shift is less than the
specified value, the optimization is finished regardless of the number
of optimization cycles or function value and its change.

<P>
</LI>
<LI><I CLASS="sans">max_iterations</I><A NAME="25203"></A> is used to prevent a waste of CPU time in the 
optimization. When that many calls of the objective function are done,
the optimization is finished regardless of the maximal atomic shift. (Note that
each optimization step usually requires more than one call of the objective
function.)

<P>
</LI>
<LI><I CLASS="sans">output</I><A NAME="25206"></A>, if <TT>'REPORT'</TT>, writes a summary of the optimization results
to the <TT>log</TT> file after optimization. If it is <TT>'NO_REPORT'</TT>, no such report
is written.

<P>
</LI>
<LI><I CLASS="sans">edat</I><A NAME="25212"></A> is an <TT>energy_data</TT> object containing objective function
parameters, if you do not want to use the defaults.
See Section&nbsp;<A HREF="node126.html#CLASS:energydata">6.3</A> for more information.

<P>
</LI>
<LI><I CLASS="sans">schedule_scale</I><A NAME="25217"></A> specifies scaling factors for the physical restraint
types, if you do not want to use the defaults.

<P>
</LI>
<LI><I CLASS="sans">residue_span_range</I><A NAME="25220"></A> determines what atom pairs can possibly 
occur in the non-bonded atom pairs list used for dynamic restraints (see
Section&nbsp;<A HREF="node108.html#SECTION:restraints">5.3</A>).

<P>
</LI>
<LI><I CLASS="sans">actions</I><A NAME="25223"></A>, if set, should be a list of periodic actions. Each is a
<A ID="tex2html151"
  HREF="https://www.python.org/">Python</A> object containing an action which is carried out periodically during
the optimization, after every step. For example, <B><A HREF="node270.html#CMD:actions.writestructure">actions.write_structure()</A></B><A NAME="25229"></A>
can be used to write out a PDB file with structure snapshots during the run,
while <B><A HREF="node271.html#CMD:actions.trace">actions.trace()</A></B><A NAME="25234"></A> writes basic information about the optimization to a
trace file. If multiple actions are given, they are run in the order they
are given.
</LI>
</UL>
<P>
<BLOCKQUOTE>It is useful in some simulations to be able to set
<I CLASS="sans"><A HREF="node128.html#MEMB:energydata.contactshell">energy_data.contact_shell</A></I><A NAME="25239"></A> to something large (<EM>e.g.</EM>, 8&#197;)
and <I CLASS="sans"><A HREF="node129.html#MEMB:energydata.updatedynamic">energy_data.update_dynamic</A></I><A NAME="25245"></A> to <TT>999999.9</TT>, so that the pairs list
is prepared only at the beginning of the optimization. However, you have to
make sure that the potential energy is not invisibly pumped into the system
by making contacts that are not on the list of non-bonded pairs (see below).
</BLOCKQUOTE>
<P>
<BLOCKQUOTE>The <TT>optimize</TT> method, when called, returns <I CLASS="sans">molpdf</I><A NAME="25252"></A>, the value of the
objective function at the end of optimization.
An exception is raised if optimization is aborted
because dynamic restraints could not be calculated as a result of a
system being too large. It is up to the calling script to ensure that sensible
action is taken; <EM>e.g.</EM>, skipping the rest of modeling for the model that resulted
in an impossible function evaluation. This option is useful when
calculating several independent models and you do not want one bad
model to abort the whole calculation. A probable reason for an interrupted
optimization is that it was far from convergence by the time the
calculation of dynamic restraints was first requested. Two possible
solutions are: (1) optimize more thoroughly (<EM>i.e.</EM> slowly) and (2) use
a different contact pairs routine (set <I CLASS="sans"><A HREF="node142.html#MEMB:energydata.nlognuse">energy_data.nlogn_use</A></I><A NAME="25257"></A> = <TT>9999</TT>).

</BLOCKQUOTE>

<P>

  <DL>
<DT><STRONG>Example: <A ID="tex2html152"
  HREF="../examples/scoring/optimize.py">examples/scoring/optimize.py</A></STRONG></DT>
<DD> <BR>  <div class="pygments"><pre><span></span><span class="c1"># Example for: conjugate_gradients(), molecular_dynamics(), model.switch_trace()</span>

<span class="c1"># This will optimize stereochemistry of a given model, including</span>
<span class="c1"># non-bonded contacts.</span>

<span class="kn">from</span> <span class="nn">modeller</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">modeller.scripts</span> <span class="kn">import</span> <span class="n">complete_pdb</span>
<span class="kn">from</span> <span class="nn">modeller.optimizers</span> <span class="kn">import</span> <span class="n">conjugate_gradients</span><span class="p">,</span> <span class="n">molecular_dynamics</span><span class="p">,</span> <span class="n">actions</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">environ</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">atom_files_directory</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;../atom_files&#39;</span><span class="p">]</span>
<span class="n">env</span><span class="o">.</span><span class="n">edat</span><span class="o">.</span><span class="n">dynamic_sphere</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">env</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="s1">&#39;$(LIB)/top_heav.lib&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="s1">&#39;$(LIB)/par.lib&#39;</span><span class="p">)</span>

<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;1fas&#39;</span>
<span class="n">mdl</span> <span class="o">=</span> <span class="n">complete_pdb</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">code</span><span class="o">+</span><span class="s1">&#39;.ini&#39;</span><span class="p">)</span>

<span class="c1"># Select all atoms:</span>
<span class="n">atmsel</span> <span class="o">=</span> <span class="n">selection</span><span class="p">(</span><span class="n">mdl</span><span class="p">)</span>

<span class="c1"># Generate the restraints:</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">restraints</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">atmsel</span><span class="p">,</span> <span class="n">restraint_type</span><span class="o">=</span><span class="s1">&#39;stereo&#39;</span><span class="p">,</span> <span class="n">spline_on_site</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">restraints</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">code</span><span class="o">+</span><span class="s1">&#39;.rsr&#39;</span><span class="p">)</span>

<span class="n">mpdf</span> <span class="o">=</span> <span class="n">atmsel</span><span class="o">.</span><span class="n">energy</span><span class="p">()</span>

<span class="c1"># Create optimizer objects and set defaults for all further optimizations</span>
<span class="n">cg</span> <span class="o">=</span> <span class="n">conjugate_gradients</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;REPORT&#39;</span><span class="p">)</span>
<span class="n">md</span> <span class="o">=</span> <span class="n">molecular_dynamics</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;REPORT&#39;</span><span class="p">)</span>

<span class="c1"># Open a file to get basic stats on each optimization</span>
<span class="n">trcfil</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="s1">&#39;.D00000001&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

<span class="c1"># Run CG on the all-atom selection; write stats every 5 steps</span>
<span class="n">cg</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">atmsel</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="n">actions</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trcfil</span><span class="p">))</span>
<span class="c1"># Run MD; write out a PDB structure (called &#39;1fas.D9999xxxx.pdb&#39;) every</span>
<span class="c1"># 10 steps during the run, and write stats every 10 steps</span>
<span class="n">md</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">atmsel</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="n">actions</span><span class="o">.</span><span class="n">write_structure</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">code</span><span class="o">+</span><span class="s1">&#39;.D9999</span><span class="si">%04d</span><span class="s1">.pdb&#39;</span><span class="p">),</span>
                     <span class="n">actions</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">trcfil</span><span class="p">)])</span>
<span class="c1"># Finish off with some more CG, and write stats every 5 steps</span>
<span class="n">cg</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">atmsel</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="n">actions</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">trcfil</span><span class="p">)])</span>

<span class="n">mpdf</span> <span class="o">=</span> <span class="n">atmsel</span><span class="o">.</span><span class="n">energy</span><span class="p">()</span>

<span class="n">mdl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">code</span><span class="o">+</span><span class="s1">&#39;.B&#39;</span><span class="p">)</span>
</pre></div>
  
</DD>
</DL>  <BR>
<P>

<DIV CLASS="navigation"><HR>
<!--Navigation Panel-->
<A
 HREF="node268.html">
<IMG WIDTH="37" HEIGHT="24" ALT="next" SRC="next.png"></A> 
<A
 HREF="node266.html">
<IMG WIDTH="26" HEIGHT="24" ALT="up" SRC="up.png"></A> 
<A
 HREF="node266.html">
<IMG WIDTH="63" HEIGHT="24" ALT="previous" SRC="prev.png"></A> 
<A ID="tex2html3173"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALT="contents" SRC="contents.png"></A> 
<A ID="tex2html3175"
  HREF="node513.html">
<IMG WIDTH="43" HEIGHT="24" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A
 HREF="node268.html">quasi_newton()   optimize</A>
<B> Up:</B> <A
 HREF="node266.html">The optimizers module: optimization</A>
<B> Previous:</B> <A
 HREF="node266.html">The optimizers module: optimization</A>
 &nbsp; <B>  <A ID="tex2html3174"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A ID="tex2html3176"
  HREF="node513.html">Index</A></B> </DIV>
<!--End of Navigation Panel-->

</BODY>
</HTML>
